# Updated pipeline
name: CI/CD for npm-motivation with JFrog

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-test:
    runs-on: self-hosted  # Runs on 192.168.0.178
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run tests with coverage
        run: npm test -- --coverage

  store-artifacts:
    needs: build-test
    runs-on: self-hosted  # Runs on 192.168.0.178
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install JFrog CLI (Without sudo)
        run: |
          curl -fL https://getcli.jfrog.io | sh
          mkdir -p ~/bin
          mv jfrog ~/bin/jfrog
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure JFrog CLI
        run: |
          if jfrog config show artifactory > /dev/null 2>&1; then
            jfrog config remove artifactory
          fi
          jfrog config add artifactory --url="https://nolet7.jfrog.io/artifactory" --apikey="${{ secrets.JFROG }}" --interactive=false
      - name: Build the project
        run: bash scripts/build.sh

      - name: Upload artifact to JFrog
        run: jfrog rt upload "dist/*" "npm-motivation-npm/"

  docker-build:
    needs: store-artifacts
    runs-on: self-hosted  # Runs on 192.168.0.178
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build and tag Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/npm-motivation:latest .
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/npm-motivation:v1.0.0

      - name: Push Docker image to DockerHub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/npm-motivation:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/npm-motivation:v1.0.0

  deploy:
    needs: docker-build
    runs-on: self-hosted  # Runs on 192.168.0.178
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Project Server (192.168.0.150)
        run: |
          ssh -o StrictHostKeyChecking=no user@192.168.0.150 << 'EOF'
          cd ~/npm-motivation
          bash scripts/deploy_project_server.sh
          EOF

